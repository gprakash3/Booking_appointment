<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
        integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <style>
        #display {
            border: 1px solid black;
            background-color: aliceblue;
            display: inline-block;
            width: 100%;
        }

        #dataarea {
            display: flex;
            background-color: aliceblue;
            margin: 10px;
            border: 1px solid black;
            text-align: center;
        }

        #display {
            width: 50%;
            margin: 10px 10px;
        }

        #leaderboard {
            width: 50%;
            margin: 10px 10px;
        }
    </style>
</head>

<body>
    <form onsubmit="expensedata(event)" class="container">
        <div class="row">
            <div class="col">
                <div class="box">
                    <label for="amount">Choose Expense Amount:</label>
                    <input type="text" id="amount" name="amount">
                    <label for="desc">Choose description:</label>
                    <input type="text" id="desc" name="desc">
                    <label for="sel">Choose category:</label>
                    <select name="sel" id="sel">
                        <option>Fuel</option>
                        <option>Food</option>
                        <option>Electricity</option>
                        <option>Movie</option>
                    </select>

                    <input type="submit" id="submitbtn" value="Add Expense">
                </div>
            </div>
        </div>

    </form>
    <div id="prembtn">
        <button type="submit" id="buypremium">Buy Premium</button>
    </div>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <div id="dataarea">
        <div id="display">
            <p>Expense</p>
        </div>
        <div id="leaderboard">
            <p>leaderboard</p>
        </div>
    </div>

</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
<script>
    const buypremium = document.getElementById('buypremium');
    buypremium.addEventListener('click', async (e) => {
        console.log('clicked');
        e.preventDefault();
        const token = localStorage.getItem('token');
        const res = await axios.get('http://localhost:3000/purchase/premiummembership', { headers: { "Authorization": token } });
        console.log('response after getting /purchase/premiummemb.', res);
        var option = {
            "key": res.data.key_id,
            "orderid": res.data.order.id,
            "handler": async function (response) {
                await axios.post('http://localhost:3000/purchase/updatetransactionstatus', {
                    order_id: option.orderid,
                    payment_id: response.razorpay_payment_id,
                }, { headers: { "Authorization": token } });
                const premdisplay = document.getElementById('prembtn');
                premdisplay.innerHTML = 'you are premium user';
                const button = document.createElement('button');
                button.type = 'submit';
                button.id = 'leaderboardbtn'
                button.innerHTML = 'show Leaderboard';
                premdisplay.appendChild(button);
                button.addEventListener('click', async (e) => {
                    const res = await axios.get('http://localhost:3000/premium/leaderboard');
                    // console.log(res.data);
                    for (let i = 0; i < res.data.datas.length; i++) {
                        showleaderboard(res.data.datas[i]);
                    }
                })
                alert('you are premium user now');
            }
        }
        const rzp1 = new Razorpay(option);
        rzp1.open();
        e.preventDefault();

        rzp1.on('payment.failed', function (response) {
            console.log(response);
            axios.post('http://localhost:3000/purchase/updatetxnfailed', {
                order_id: option.orderid,
                payment_id: 'Failed Payment',
            }, { headers: { "Authorization": token } });
            // })
            alert('something went wrong');
        })

    })

    function expensedata(e) {
        e.preventDefault();


        const amount = document.getElementById('amount').value;
        const description = document.getElementById('desc').value;
        const category = document.getElementById('sel').value;
        const obj = { amount: amount, description: description, category: category };
        const promise = addtodb(obj);
    }

    async function addtodb(obj) {
        try {
            const token = localStorage.getItem('token');
            const res = await axios.post('http://localhost:3000/addData', obj, { headers: { "Authorization": token } });
            showonscreen(res.data.datas);
        }
        catch (err) {
            console.log('error in adding to db');
            console.log(err);
        }
    }

    function showonscreen(obj) {
        const div = document.createElement('div');
        const li = document.createElement('li');

        li.appendChild(document.createTextNode(obj.amount));
        li.appendChild(document.createTextNode('-'));
        li.appendChild(document.createTextNode(obj.category));
        li.appendChild(document.createTextNode('-'));
        li.appendChild(document.createTextNode(obj.description));
        const del = document.createElement('button');
        del.innerHTML = 'DELETE EXPENSE';
        li.appendChild(del);
        div.appendChild(li);
        display.appendChild(div);
        del.addEventListener('click', async (e) => {
            display.removeChild(div);
            const token = localStorage.getItem('token');
            const data = await axios.post('http://localhost:3000/delete', obj, { headers: { "Authorization": token } });
            console.log(data);
        })
    }


    function fetchdata(obj) {
        document.getElementById('amount').value = obj.amount;
        document.getElementById('desc').value = obj.description;
        document.getElementById('sel').value = obj.category;
    }

    function creatediv(obj) {
        const li = document.createElement('li');

        li.appendChild(document.createTextNode(obj.amount));
        li.appendChild(document.createTextNode('-'));
        li.appendChild(document.createTextNode(obj.category));
        li.appendChild(document.createTextNode('-'));
        li.appendChild(document.createTextNode(obj.description));
        // li.appendChild(document.createTextNode(obj.amount));
        const del = document.createElement('button');
        del.innerHTML = 'DELETE';
        li.appendChild(del);


        return li;
    }

    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const token = localStorage.getItem('token');
            console.log(token);
            const resp = await axios.get('http://localhost:3000/checkpremiumuser', { headers: { "Authorization": token } })
            if (resp.data.flag === true) {
                const premdisplay = document.getElementById('prembtn');
                premdisplay.innerHTML = 'you are premium user';
                const button = document.createElement('button');
                button.id = 'leaderboardbtn'
                button.type = 'submit';
                button.innerHTML = 'show Leaderboard';
                premdisplay.appendChild(button);
                button.addEventListener('click', async (e) => {
                    const res = await axios.get('http://localhost:3000/premium/leaderboard');
                    // console.log(res.data);
                    for (let i = 0; i < res.data.datas.length; i++) {
                        showleaderboard(res.data.datas[i]);
                    }
                })
            }
            else {
                document.getElementById('leaderboard').hidden = true;
            }

            const res = await axios.get('http://localhost:3000/getAllData', { headers: { "Authorization": token } });
            for (let i = 0; res.data.datas.length; i++) {
                showonscreen(res.data.datas[i]);
            }
        }
        catch (err) {
            console.log('error in getting all data');
            console.log(err);
        }
    })
    function showleaderboard(obj) {
        const li = document.createElement('li');
        li.appendChild(document.createTextNode('Name: '));
        li.appendChild(document.createTextNode(obj.name));
        li.appendChild(document.createTextNode('--'));
        li.appendChild(document.createTextNode('Expense: '))
        li.appendChild(document.createTextNode(obj.expense));
        document.getElementById('leaderboard').appendChild(li);

    }
</script>

</html>