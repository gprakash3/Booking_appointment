<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
        integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <style>
        #display {
            border: 1px solid black;
            background-color: aliceblue;
            display: inline-block;
            width: 100%;
        }

    </style>
</head>

<body>
    <form onsubmit="expensedata(event)" class="container">
        <div class="row">
            <div class="col">
                <div class="box">
                    <label for="amount">Choose Expense Amount:</label>
                    <input type="text" id="amount" name="amount">
                    <label for="desc">Choose description:</label>
                    <input type="text" id="desc" name="desc">
                    <label for="sel">Choose category:</label>
                    <select name="sel" id="sel">
                        <option>Fuel</option>
                        <option>Food</option>
                        <option>Electricity</option>
                        <option>Movie</option>
                    </select>

                    <input type="submit" id="submitbtn" value="Add Expense">
                </div>
            </div>
        </div>

    </form>

    <div id="display">
    </div>

</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
<script src="app.js"></script>
<script>
    var editId = -1;
    const display = document.getElementById('display');
    

    async function expensedata(e) {
        try{
        e.preventDefault();
        const amount = document.getElementById('amount').value;
        const description = document.getElementById('desc').value;
        const category = document.getElementById('sel').value;
        
        if(editId != -1){
            const obj = { amount, description, category, editId };
            editId = -1;
            const res = await postUpdateData(obj);
            console.log('data updated');
            
        }
        else{
            const obj = { amount, description, category };
            const res = await postAddData(obj);
            
        }
            console.log('added to db');
            document.getElementById('amount').value="";
            document.getElementById('desc').value="";
            document.getElementById('sel').value="";
    }
    catch(err){
        console.log(err);
    }
    }


    //adding data to database
    async function postAddData(myobj) {
        try {
            const res = await axios.post('http://localhost:3000/add', myobj);
            console.log(res.data);
            showdata(res.data.expensedata);
        }
        catch (err) {
            console.log(err);
        }
    }

    //show data on screen
    async function showdata(obj) {
        try{
        const li = document.createElement('li');
        li.appendChild(document.createTextNode(obj.description));
        li.appendChild(document.createTextNode('-'));
        li.appendChild(document.createTextNode(obj.category));
        li.appendChild(document.createTextNode('-'));
        li.appendChild(document.createTextNode(obj.amount));

        const del = document.createElement('button');
        del.appendChild(document.createTextNode('DELETE'));
        li.appendChild(del);

        const edit = document.createElement('button');
        edit.appendChild(document.createTextNode('EDIT'));
        li.appendChild(edit);

        display.appendChild(li);

        //remove data from screen and database
        del.addEventListener('click', (e) => {
            e.preventDefault();
            display.removeChild(li);           
             const res = deleteelement(obj);
             console.log('deleted');
        });

        //remove data from screen, fetch data to input boxes
        edit.addEventListener('click', (e) => {           
            e.preventDefault();
            display.removeChild(li);
            const res = fetchedit(obj);
            console.log('fetched data to box');
        })
    }
    catch(err){console.log(err)}

    }

    //Delete element from database
    async function deleteelement(obj) {
        try {
              axios.post('http://localhost:3000/delete', obj).then(resp => {
                console.log('deleted element from axios');
              });
        }
        catch (error) {
            console.log(error);
        }
    }

    //fetching data from database on clicking edit button and store ID of fetched data.
    async function fetchedit(obj) {
        try {
            //we have to get specific data
            const res = await axios.post('http://localhost:3000/edit', obj);
            console.log(res.data.datas[0]);
            //check here
            editId  = res.data.datas[0].id;
            document.getElementById('amount').value=res.data.datas[0].amount;
            document.getElementById('desc').value=res.data.datas[0].description;
            document.getElementById('sel').value=res.data.datas[0].category;
        }
        catch (err) {
            console.log(err);
        }
    }

    //Update data to database
    async function postUpdateData(obj, id) {
        try{
        showdata(obj);
        const res = await axios.post('http://localhost:3000/update', obj);
        console.log('update successful');
        }
        catch(err){
            console.log(err);
        }
    }


    //action perform on reload of screen
    window.addEventListener("DOMContentLoaded", () => {
        showonreload();
    });

    //getting add data from database and display on screen
    async function showonreload() {
        try {
            const res = await axios.get('http://localhost:3000/data');
            for (let i = 0; i < res.data.datas.length; i++) {
                showdata(res.data.datas[i]);
            }
        }
        catch (err) { console.log(err); }
    }
</script>

</html>